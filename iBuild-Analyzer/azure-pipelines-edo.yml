# Azure pipeline generated by Eradani Analyzer
# Variables will be set to unique values for this run
#   and can be customized at will.

trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
# You must specify the name of the IBM Connection
# defined under Project settings->Service connections.
- name: IBMICONNECTION
  value: TODO
- name: STAGINGDIR
  value: /home/azure/staging$(Build.BuildId)
- name: LIB1
  value: '@AZ$(Build.BuildId)_L1'    # originally DMDMOP1OBJ
- name: LIB2
  value: '@AZ$(Build.BuildId)_L2'    # originally DMDEMOPRD1

steps:
#  Copy the makefiles to the IBM i system
- task: CopyFilesOverSSH@0
  inputs:
    sshEndpoint: '$(IBMICONNECTION)'
    sourceFolder: 'iBuild-Analyzer/CRTCMDS'
    contents: '*'
    targetFolder: '$(STAGINGDIR)/makefiles'
    readyTimeout: '20000'

#  Execute a script to do a build on the IBM i system
- task: SSH@0
  inputs:
    sshEndpoint: '$(IBMICONNECTION)'
    runOptions: 'inline'
    inline: |
      # Clone everything we need for the build
      # into staging libraries.
      # Format for the clone calls are as follows:
      #   system "GITCLONE REPO('<git URL>') FLDER('$(REPODIR)') LIB(SRCLIB)"
      # Or for IFS repositories:
      #   git clone -q <git URL> $(STAGINGDIR)/ifsrepo

      # Create and configure LIB1 (originally DMDEMOPRD1)
      system "CRTLIB $(LIB2)"
      system "GITCLONE REPO('git@github.com:danmdemo/dmdemo.git') FLDER('$(STAGINGDIR)/LIB2') LIB($(LIB2))"

      # Execute each makefile in the project.
      cd $(STAGINGDIR)/makefiles
      for makefile in *
      do
          /QOpenSys/pkgs/bin/gmake LIB1=$(LIB1) LIB2=$(LIB2) -f $makefile
      done
    interpreterCommand: '/QOpenSys/pkgs/bin/bash'
    readyTimeout: '20000'
